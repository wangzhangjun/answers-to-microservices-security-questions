### Question

如果您需要升级密码存储算法，那么如何确保不对用户造成大规模中断的情况下完成此操作？

### Answer

升级密码算法，进行身份迁移，升级认证方式等这些需求往往不希望打扰用户，希望用户是无感知的（避免让用户重置或者找回密码）。所以，对于这个问题来说，我们的挑战往往是我们的数据库中是不存在用户的明文密码（如果您这样做，请尽快参阅此[文章](https://crackstation.net/hashing-security.htm)以替换纯文本密码），即使这些密码受到一些不安全的算法的保护而已，在过程中我们不希望用户重置自己的密码。

第一个解决方案是，我们将旧的已被哈希的密码视为新存储密码算法的明文输入，显而易见这个方案很好操作，很多情况下创建一张新表然后一个后台脚本就足够了，等密码转换完成后，我们的切换也比较简单。当我们构建新的身份认证系统时，这个方式也是最简单的，但是缺点也很明显，我们必须永远在代码中使用这些旧的算法，这个技术债很难摆脱。

另一种方案是让用户启动密码迁移，当一个用户进行登录或者重置密码时，我们就能够拿到用户的明文密码，然后我们使用新的安全算法进行加密并存储。直到未来大多数的用户完成了密码迁移，我们就可以去除老的加密算法了，对于那些没有在迁移过程中登录的用户，我们可以让他们进行密码找回。当然缺点也是显而易见的，这个迁移会耗费大量的时间，一旦有用户进行了密码找回，那么很有可能我们会丢失这些用户。

### Reference
- [Salted Password Hashing - Doing it Right](https://crackstation.net/hashing-security.htm)
- [Password Storage Cheat Sheet](https://www.owasp.org/index.php/Password_Storage_Cheat_Sheet)
